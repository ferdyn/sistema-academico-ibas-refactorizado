import mongoose from 'mongoose';
import bcrypt from 'bcryptjs';
import Database from '../config/database';
import User from '../models/User';
import Nivel from '../models/Nivel';
import Materia from '../models/Materia';
import Curso from '../models/Curso';
import Inscripcion from '../models/Inscripcion';
import Tarea from '../models/Tarea';
import Pago from '../models/Pago';

/**
 * Script de seed para poblar la base de datos con datos de prueba
 * Formato europeo - Espa√±a
 */

const seedDatabase = async () => {
  try {
    console.log('üå± Iniciando seed de la base de datos...');
    
    // Conectar a la base de datos
    const db = Database.getInstance();
    await db.connect();
    
    // Limpiar colecciones existentes
    await User.deleteMany({});
    await Nivel.deleteMany({});
    await Materia.deleteMany({});
    await Curso.deleteMany({});
    await Inscripcion.deleteMany({});
    await Tarea.deleteMany({});
    await Pago.deleteMany({});
    
    console.log('üóëÔ∏è  Colecciones limpiadas');

    // Hash para contrase√±as
    const saltRounds = 12;
    const hashPassword = async (password: string) => {
      const salt = await bcrypt.genSalt(saltRounds);
      return bcrypt.hash(password, salt);
    };

    // Crear usuarios
    const usuarios = [
      {
        nombre: 'Ana',
        apellidos: 'Rodr√≠guez Garc√≠a',
        email: 'admin@ibas.edu',
        password: await hashPassword('admin123'),
        rol: 'administrador',
        telefono: '654321098',
        dni: '12345678Z',
        fechaNacimiento: new Date('1985-06-15'),
        direccion: 'Calle Mayor, 123, 28001 Madrid',
        activo: true
      },
      {
        nombre: 'Jos√©',
        apellidos: 'S√°nchez L√≥pez',
        email: 'jsanchez@ibas.edu',
        password: await hashPassword('profesor123'),
        rol: 'profesor',
        telefono: '678901234',
        dni: '87654321A',
        fechaNacimiento: new Date('1978-03-22'),
        direccion: 'Avenida de la Constituci√≥n, 45, 41001 Sevilla',
        especialidad: 'Matem√°ticas',
        activo: true
      },
      {
        nombre: 'Carmen',
        apellidos: 'Mart√≠nez Ruiz',
        email: 'cmartinez@ibas.edu',
        password: await hashPassword('profesor123'),
        rol: 'profesor',
        telefono: '687123456',
        dni: '56789123C',
        fechaNacimiento: new Date('1982-11-08'),
        direccion: 'Plaza del Ayuntamiento, 12, 46002 Valencia',
        especialidad: 'Lengua Castellana y Literatura',
        activo: true
      },
      {
        nombre: 'Pedro',
        apellidos: 'Garc√≠a Mart√≠n',
        email: 'pedro.garcia@estudiante.ibas.edu',
        password: await hashPassword('alumno123'),
        rol: 'alumno',
        telefono: '612345678',
        dni: '45678912B',
        fechaNacimiento: new Date('2008-09-10'),
        direccion: 'Plaza Espa√±a, 78, 08014 Barcelona',
        tutorLegal: 'Mar√≠a Mart√≠n Ruiz',
        telefonoTutor: '698765432',
        activo: true
      },
      {
        nombre: 'Mar√≠a',
        apellidos: 'L√≥pez Fern√°ndez',
        email: 'maria.lopez@estudiante.ibas.edu',
        password: await hashPassword('alumno123'),
        rol: 'alumno',
        telefono: '687654321',
        dni: '78912345D',
        fechaNacimiento: new Date('2007-12-03'),
        direccion: 'Calle Alcal√°, 156, 28009 Madrid',
        tutorLegal: 'Carmen Fern√°ndez Ruiz',
        telefonoTutor: '654987321',
        activo: true
      },
      {
        nombre: 'Luis',
        apellidos: 'Hern√°ndez Torres',
        email: 'luis.hernandez@estudiante.ibas.edu',
        password: await hashPassword('alumno123'),
        rol: 'alumno',
        telefono: '634567890',
        dni: '34567891E',
        fechaNacimiento: new Date('2008-05-20'),
        direccion: 'Calle Gran V√≠a, 89, 48011 Bilbao',
        tutorLegal: 'Ana Torres L√≥pez',
        telefonoTutor: '676543210',
        activo: true
      }
    ];

    const usuariosCreados = await User.insertMany(usuarios);
    console.log(`üë• ${usuariosCreados.length} usuarios creados`);

    // Crear niveles educativos
    const niveles = [
      {
        nombre: 'Educaci√≥n Secundaria Obligatoria (ESO)',
        descripcion: 'Educaci√≥n secundaria obligatoria en Espa√±a',
        grados: ['1¬∫ ESO', '2¬∫ ESO', '3¬∫ ESO', '4¬∫ ESO'],
        activo: true
      },
      {
        nombre: 'Bachillerato',
        descripcion: 'Educaci√≥n post-obligatoria preuniversitaria',
        grados: ['1¬∫ Bachillerato', '2¬∫ Bachillerato'],
        activo: true
      },
      {
        nombre: 'Formaci√≥n Profesional',
        descripcion: 'Ciclos formativos de grado medio y superior',
        grados: ['Grado Medio', 'Grado Superior'],
        activo: true
      }
    ];

    const nivelesCreados = await Nivel.insertMany(niveles);
    console.log(`üìö ${nivelesCreados.length} niveles educativos creados`);

    // Crear asignaturas
    const materias = [
      {
        nombre: 'Matem√°ticas',
        codigo: 'MAT',
        descripcion: '√Ålgebra, geometr√≠a, trigonometr√≠a y c√°lculo',
        creditos: 4,
        nivelId: nivelesCreados[0]._id,
        activa: true
      },
      {
        nombre: 'Lengua Castellana y Literatura',
        codigo: 'LCL',
        descripcion: 'Gram√°tica, literatura espa√±ola y expresi√≥n escrita',
        creditos: 4,
        nivelId: nivelesCreados[0]._id,
        activa: true
      },
      {
        nombre: 'Ingl√©s',
        codigo: 'ING',
        descripcion: 'Idioma extranjero - ingl√©s nivel intermedio',
        creditos: 3,
        nivelId: nivelesCreados[0]._id,
        activa: true
      },
      {
        nombre: 'Ciencias Naturales',
        codigo: 'CCN',
        descripcion: 'Biolog√≠a, f√≠sica y qu√≠mica integradas',
        creditos: 3,
        nivelId: nivelesCreados[0]._id,
        activa: true
      },
      {
        nombre: 'Historia de Espa√±a',
        codigo: 'HIS',
        descripcion: 'Historia contempor√°nea espa√±ola',
        creditos: 3,
        nivelId: nivelesCreados[1]._id,
        activa: true
      },
      {
        nombre: 'Filosof√≠a',
        codigo: 'FIL',
        descripcion: 'Introducci√≥n a la filosof√≠a y √©tica',
        creditos: 2,
        nivelId: nivelesCreados[1]._id,
        activa: true
      }
    ];

    const materiasCreadas = await Materia.insertMany(materias);
    console.log(`üìñ ${materiasCreadas.length} asignaturas creadas`);

    // Buscar profesores
    const profesorMates = usuariosCreados.find(u => u.especialidad === 'Matem√°ticas');
    const profesorLengua = usuariosCreados.find(u => u.especialidad === 'Lengua Castellana y Literatura');

    // Crear cursos
    const cursos = [
      {
        materiaId: materiasCreadas[0]._id,
        profesorId: profesorMates!._id,
        nombre: 'Matem√°ticas 3¬∫ ESO - Grupo A',
        descripcion: '√Ålgebra y geometr√≠a para tercero de ESO',
        periodo: 'Curso 2023-24',
        horario: 'Lunes, Mi√©rcoles, Viernes 09:00-10:00',
        aula: 'Aula 205',
        maxEstudiantes: 25,
        activo: true,
        fechaInicio: new Date('2023-09-15'),
        fechaFin: new Date('2024-06-15')
      },
      {
        materiaId: materiasCreadas[1]._id,
        profesorId: profesorLengua!._id,
        nombre: 'Lengua Castellana 3¬∫ ESO - Grupo A',
        descripcion: 'Literatura y expresi√≥n escrita para tercero de ESO',
        periodo: 'Curso 2023-24',
        horario: 'Martes, Jueves 10:00-11:00',
        aula: 'Aula 103',
        maxEstudiantes: 25,
        activo: true,
        fechaInicio: new Date('2023-09-15'),
        fechaFin: new Date('2024-06-15')
      },
      {
        materiaId: materiasCreadas[2]._id,
        profesorId: profesorMates!._id,
        nombre: 'Ingl√©s 3¬∫ ESO - Grupo A',
        descripcion: 'Ingl√©s intermedio para tercero de ESO',
        periodo: 'Curso 2023-24',
        horario: 'Lunes, Mi√©rcoles 11:00-12:00',
        aula: 'Aula 301',
        maxEstudiantes: 20,
        activo: true,
        fechaInicio: new Date('2023-09-15'),
        fechaFin: new Date('2024-06-15')
      }
    ];

    const cursosCreados = await Curso.insertMany(cursos);
    console.log(`üéì ${cursosCreados.length} cursos creados`);

    // Buscar estudiantes
    const estudiantes = usuariosCreados.filter(u => u.rol === 'alumno');

    // Crear inscripciones
    const inscripciones = [];
    estudiantes.forEach(estudiante => {
      cursosCreados.forEach((curso, index) => {
        inscripciones.push({
          estudianteId: estudiante._id,
          cursoId: curso._id,
          fechaInscripcion: new Date('2023-09-01'),
          estado: 'activa',
          notaFinal: 5 + Math.random() * 5, // Notas entre 5 y 10
          asistencia: 85 + Math.random() * 15 // Asistencia entre 85% y 100%
        });
      });
    });

    const inscripcionesCreadas = await Inscripcion.insertMany(inscripciones);
    console.log(`üìù ${inscripcionesCreadas.length} inscripciones creadas`);

    // Crear tareas
    const tareas = [
      {
        cursoId: cursosCreados[0]._id,
        titulo: 'Ecuaciones de segundo grado',
        descripcion: 'Resolver sistemas de ecuaciones cuadr√°ticas usando la f√≥rmula general',
        fechaCreacion: new Date('2024-01-10'),
        fechaVencimiento: new Date('2024-01-25'),
        puntuacionMaxima: 10,
        estado: 'activa',
        instrucciones: 'Completar todos los ejercicios del tema 5, p√°ginas 78-82. Mostrar el procedimiento completo.'
      },
      {
        cursoId: cursosCreados[1]._id,
        titulo: 'An√°lisis de "La Celestina"',
        descripcion: 'Ensayo sobre los personajes principales de la obra de Fernando de Rojas',
        fechaCreacion: new Date('2024-01-12'),
        fechaVencimiento: new Date('2024-01-30'),
        puntuacionMaxima: 10,
        estado: 'activa',
        instrucciones: 'Ensayo de 500 palabras m√≠nimo. Analizar la evoluci√≥n de Calisto y Melibea.'
      },
      {
        cursoId: cursosCreados[2]._id,
        titulo: 'Present Perfect Tense',
        descripcion: 'Ejercicios de presente perfecto en ingl√©s',
        fechaCreacion: new Date('2024-01-15'),
        fechaVencimiento: new Date('2024-02-01'),
        puntuacionMaxima: 10,
        estado: 'activa',
        instrucciones: 'Complete exercises 1-15 from workbook page 45. Write 5 original sentences.'
      }
    ];

    const tareasCreadas = await Tarea.insertMany(tareas);
    console.log(`üìã ${tareasCreadas.length} tareas creadas`);

    // Crear pagos
    const pagos = [];
    estudiantes.forEach(estudiante => {
      // Matr√≠cula anual
      pagos.push({
        estudianteId: estudiante._id,
        concepto: 'Matr√≠cula Curso 2023-24',
        descripcion: 'Matr√≠cula completa para el curso acad√©mico 2023-2024',
        importe: 450.00,
        fechaVencimiento: new Date('2023-09-30'),
        fechaPago: new Date('2023-09-15'),
        metodoPago: 'transferencia',
        estado: 'pagado',
        numeroRecibo: `MAT-2023-${String(estudiante._id).slice(-3).toUpperCase()}`
      });

      // Material did√°ctico
      pagos.push({
        estudianteId: estudiante._id,
        concepto: 'Material did√°ctico',
        descripcion: 'Libros de texto y material escolar',
        importe: 85.50,
        fechaVencimiento: new Date('2023-10-15'),
        fechaPago: Math.random() > 0.5 ? new Date('2023-10-10') : undefined,
        metodoPago: Math.random() > 0.5 ? 'tarjeta' : undefined,
        estado: Math.random() > 0.5 ? 'pagado' : 'pendiente',
        numeroRecibo: `MAT-2023-${String(estudiante._id).slice(-3).toUpperCase()}-B`
      });

      // Actividades extraescolares
      if (Math.random() > 0.3) {
        pagos.push({
          estudianteId: estudiante._id,
          concepto: 'Actividades extraescolares',
          descripcion: 'Actividades deportivas y culturales',
          importe: 120.00,
          fechaVencimiento: new Date('2024-01-31'),
          estado: 'pendiente',
          numeroRecibo: `ACT-2024-${String(estudiante._id).slice(-3).toUpperCase()}`
        });
      }
    });

    const pagosCreados = await Pago.insertMany(pagos);
    console.log(`üí∞ ${pagosCreados.length} pagos creados`);

    console.log('\nüéâ Seed completado exitosamente!');
    console.log('\nüë• Usuarios de prueba creados:');
    console.log('üëë Administrador: admin@ibas.edu / admin123');
    console.log('üë®‚Äçüè´ Profesor (Matem√°ticas): jsanchez@ibas.edu / profesor123');
    console.log('üë®‚Äçüè´ Profesora (Lengua): cmartinez@ibas.edu / profesor123');
    console.log('üë®‚Äçüéì Alumno 1: pedro.garcia@estudiante.ibas.edu / alumno123');
    console.log('üë©‚Äçüéì Alumna 2: maria.lopez@estudiante.ibas.edu / alumno123');
    console.log('üë®‚Äçüéì Alumno 3: luis.hernandez@estudiante.ibas.edu / alumno123');
    console.log('\nüí∞ Moneda configurada: EUR (Euro)');
    console.log('üóìÔ∏è Formato de fechas: dd/MM/yyyy');
    console.log('üá™üá∏ Configuraci√≥n: Espa√±a');

  } catch (error) {
    console.error('‚ùå Error durante el seed:', error);
    process.exit(1);
  } finally {
    await mongoose.disconnect();
    console.log('\nüîå Desconectado de la base de datos');
    process.exit(0);
  }
};

// Ejecutar seed si se llama directamente
if (require.main === module) {
  seedDatabase();
}

export default seedDatabase;
